# 7.3 효율적인 정보 저장을 위한 메모리 계층 구조

컴퓨터 = CPU가 간단한 명령어를 실행하면 동작

- 명령어 → CPU 레지스터에 저장된 데이터만 연산 가능

  - but 레지스터는 용량이 작음 (대게 1천 byte 미만)
  - so 끊임없이 RAM과 데이터를 주고받아야 함
  - 메모리 접근 속도가 느리면, CPU는 RAM이 데이터를 읽고쓰는 작업을 하는 동안 기다려야함

    → 메모리 속도를 높이는 것의 중요성! (성능과 직접적인 연관)

  - CPU가 레지스터에 접근하는 데 걸리는 시간은 한 주기 이내 (순식간)

    RAM은 훨씬 느림 ㅠ

### 프로세서-메모리 격차

- CPU속도는 기술 발전에 따라 지수적으로 증가
  - CPU 명령어는 짧은 시간에 많이 수행 가능해서 비용이 많이 들지 X
- RAM도 빠르게 증가했지만, CPU에 비해 증가율 낮음
  - RAM에서 데이터를 가져오는 데는 시간이 훨씬 많이 들어서 오래걸림
  - 요즘은 약 1천 CPU 주기라고함 (1 micro초), 그래도 느린편

⇒ 이러한 CPU-RAM 메모리 성능차이를 '프로세서-메모리 격차'라고 함

- 이 격차가 벌어질수록, 메모리에 효육적으로 접근하는게 중요!

  → 동일한 계산을 처리하는데 필요한 RAM 연산횟수를 줄이는 방법의 필요성

### 시간, 공간 인접 주소

RAM 접근 횟수 최소화하는 방법에 대해 고민하던 컴퓨터과학자들이 깨달은 규칙

- **시간 인접 주소 (temporal locality)**
  - 어떤 메모리주소에 접근한 경우, 잠시 후 같은 주소에 다시 접근할 가능성이 높음
- **공간 인접 주소 (spatial locality**
  - 어떤 메모리주소에 접근한 경우, 잠시 후 인접한 주소에 접근할 가능성이 높음

조만간 접근이 발생할 가능성이 높은 메모리 주소들을 예측해, CPU 레지스터에 미리 저장해둔다면?!

- RAM 접근 연산을 상당히 줄일 수 있겠군!
- 근데 그러면 레지스터 용량이 엄청 커야할텐데..? 근데 아직 그럴만한 CPU칩을 설계할 방법은 없는데..?

### 1차 캐시 (L1 Cache)

레지스터 용량은 못늘려도, CPU와 통합된 매우 빠른 보조메모리 만드는 것은 가능

- L1 데이터 → 레지스터로 옮기는건, 레지스터 자체 데이터에 접근하는 것보다 조금 느림
- 접근 가능성이 높은 메모리주소의 내용을, CPU 레지스터 가까이에 복사해둘 수 있음
  - CPU레지스터와 더 가까이에 있으니, 더 빠르게 데이터 전달 가능
  - 약 10 CPU 주기밖에 안걸림 (거의 100배 빨라짐)
  - 10KB 정도의 L1 캐시면, 거의 RAM 요청 중 절반 이상을 수행 가능
  - CPU 데이터 대기시간 매우 줄어듦 → 성능 향상!

### 2차 캐시 (L2 Cache)

그럼 1차 캐시의 용량이 커질수록, RAM에서 데이터를 조회하는 연산횟수는 더더욱 줄어드는게 아닌가?

- 하지만, L1 속도를 그대로 놔두고 용량만 늘리는건 어려움 ㅠ
  - 50KB 넘어가면, 용량 늘리는 비용이 매우 높아짐
- 그러면 메모리 캐시를 아예 한단계 더 추가하자! = L2 캐시
- 최근에는 L3 캐시 탑재한 프로세서도 출시
- CPU 칩에서 대부분의 공간을 이 캐시들이 차지할 정도로 중요!

접근 가능성이 가장 높은 메모리주소 → L1 캐시에 복사

그다음 높은 메모리주소 → L2 캐시에 복사

⇒ CPU는 접근하려는 메모리가 L1에 없으면, L2에서 찾고, 그래도 없으면 RAM에 직접 접근!

이렇게 L1, L2, L3 캐시를 활용한 덕에 컴퓨터 성능은 극적으로 향상됨

- 200KB L2캐시 → RAM 직접요청이 10% 미만으로 줄어듦
- 좋은 CPU는 캐시 용량이 더 크니, 컴퓨터 살 때 L1, L2, L3 용량 따져보기

### 1차 메모리, 2차 메모리

컴퓨터에는 여러 종류의 메모리가 탑재되는데, 이 다양한 메모리들은 속도, 용량, 비용에 따라 계층 구조를 형성

- 위쪽에 있을수록 속도가 빠르고, 용량이 작고, 비쌈
- 아래쪽에 있을수록 접근속도가 느리고, 용량이 크고, 저렴
- 한 레벨의 저장장치가 다음 하위레벨 저장장치의 캐시 역할을 함

CPU 레지스터 다음에 캐시들이 오고, 그다음에 RAM이 있음

- RAM

  - 실행중인 모든 프로세서의 데이터와 코드를 저장하는 역할 담당

    → 보통 많아야 16GB (?) 정도인데, 운영체제나 실행하는 프로그램을 모두 담기엔 부족

- HDD(하드디스크)
  - TB 단위까지도 나옴, 실행중인 모든 프로그램 데이터 담기 충분
  - RAM이 가득 찼을때, 당장 사용하지 않아서 우선순위가 낮은 데이터를 HDD로 옯겨 메모리 공간 확보하기도 함 (가상메모리)
  - but, 속도가 매ㅐㅐ우 느림 (HDD → RAM 1백만 CPU주기..)

RAM, HDD의 속도, 용도 차이가 드러남

- RAM = 1차 메모리
- HDD = 2차 메모리 (디스크에 저장된 프로그램, 데이터)
  - CPU는 2차 메모리에 직접 접근 불가
  - 2차 메모리에 저장된 프로그램은 실행 전, 1차 메모리로 복사되어야 함
  - OS도 컴퓨터 부팅시마다 디스크에서 RAM으로 복사된 후에야 CPU로 실행 가능

### 스레싱 모드 (thrashing mode)

보통 작업을 수행할 때, 컴퓨터 한대에서 동시에 처리하는 데이터, 프로그램이 RAM 용량을 초과하지 않게 주의해야함 (RAM 부족상태)

- 초과시, HDD-RAM 사이에서 끊임없이 데이터를 전송 (매우 느림, 연산이 아니라 이동에 시간 다씀)

스레싱 모드

- HDD에서 RAM으로 데이터를 끊임없이 읽어들이는 상태
- 특히 서버같은 경우, 스레싱 모드에 빠지지 않게 주의해야함
  - 서버 다운의 원인이 될 수 있음

### 외부 저장장치

컴퓨터가 네트워크에 연결되면, 로컬이나 인터넷을 통해 다른 컴퓨터가 관리하는 메모리에 접근 가능

- 접근시간은 훨씬 오래걸림

### 3차 저장장치

- 언제나 컴퓨터와 연결되어 있는게 아닌 저장장치
- 늘 사용가능한 상태가 아닌 저장장치
- ex. 자기테이프 카트리지, CD..
- 여기에 저장된 데이터에 접근하려면, 매체를 꺼내 재생장치에 삽입하는 과정을 거쳐야함
  - 접근할일이 많지 않은 데이터 보관 용도로 쓰는게 적합

### 메모리 기술 동향

빠른메모리에 사용되는 기술은 그다지 발전X, 느린 메모리는 점점 더 빨라지고 저렴해짐

**SSD (Solid State Drive)**

- HDD와 달리, 모터나 헤드같은 움직이는 부품X → 더 안정적, 빠름, 전력소모 덜함
- 아직까진 그래도 비싼 편
- 일부 제조사는 SSD + 자기디스크 ⇒ 하이브리드 디스크 생산하기도 함
  - 자주사용하는 데이터는 SSD에, 아닌건 자기부품에 저장
  - 접근 빈도가 높아지면 SSD로 옮겨줌 (CPU-캐시 관계랑 비슷)
